# NPM



[TOC]

### 	

### 简介

`npm` 是 Node.js 标准的软件包管理器。

在 2017 年 1 月时，npm 仓库中就已有超过 350000 个软件包，这使其成为世界上最大的单一语言代码仓库，并且可以确定几乎有可用于一切的软件包。

它起初是作为下载和管理 Node.js 包依赖的方式，但其现在也已成为前端 JavaScript 中使用的工具。

`npm` 有很多功能。

[**Yarn**](https://yarnpkg.com/en/) *是 npm 的一个替代选择。*

##### 下载

运行

```
npm install
```

它会在 `node_modules` 文件夹（如果尚不存在则会创建）中安装项目所需的所有东西。

##### 安装特定软件包

```
npm install <package-name>
```

通常会在此命令中看到更多标志：

- `--save` 安装并添加条目到 `package.json` 文件的 dependencies。
- `--save-dev` 安装并添加条目到 `package.json` 文件的 devDependencies。

区别主要是，`devDependencies` 通常是开发的工具（例如测试的库），而 `dependencies` 则是与生产环境中的应用程序相关。

##### 更新软件包

使用

```
npm update
```

来更新软件包

或者指定某个软件包进行更新

```
npm update <package-name>
```

##### 版本控制

除了简单的下载外，`npm` 还可以管理版本控制，因此可以指定软件包的任何特定版本，或者要求版本高于或低于所需版本。

很多时候，一个库仅与另一个库的主版本兼容。

或者，一个库的最新版本中有一个缺陷（仍未修复）引起了问题。

指定库的显式版本还有助于使每个人都使用相同的软件包版本，以便整个团队运行相同的版本，直至 `package.json` 文件被更新。

在所有这些情况中，版本控制都有很大的帮助，`npm` 遵循语义版本控制标准。

### 两种安装方式

`npm`安装包时有两种方式分别是：全局安装和本地安装

当输入`npm install lodash`时，`lodash`这个包会被安装到本地文件夹树下的`node-modules`中。这种情况下，`npm` 还会在当前文件夹中存在的 `package.json` 文件的 `dependencies` 属性中添加 `lodash` 条目。

当输入`npm install -g lodash`时表示的是全局安装，这时包不会安装到本地的`node_module`下，而是安装到全局文件夹下

使用命令`npm root -g`来获取全局文件夹的位置

```
npm root -g

C:\Users\dedsec\AppData\Roaming\npm\node_modules
```

### 使用或者获取npm下载的软件包

当使用本地安装安装了`lodash`时

```
npm install lodash
```

在代码中想要使用`lodash`直接

```
const _=require('lodash')
```

如果软件包是可执行文件，该怎么办？

在这种情况下，它会把可执行文件放到 `node_modules/.bin/` 文件夹下。

比如使用`cowsay`

cowsay 软件包提供了一个命令行程序，可以执行该程序以使母牛说些话（以及其他动物也可以说话）。

当使用 `npm install cowsay` 安装软件包时，它会在 node_modules 文件夹中安装自身以及一些依赖包：

可以输入 `./node_modules/.bin/cowsay` 来运行它，但是最新版本的 npm（自 5.2 起）中包含的 npx 是更好的选择。 只需运行：

```
npx cowsay
```

npx可以找到程序包的位置

### package.JSON

`package.json` 文件是项目的清单。 它可以做很多完全互不相关的事情。 例如，它是用于工具的配置中心。 它也是 `npm` 和 `yarn` 存储所有已安装软件包的名称和版本的地方。

- `version` 表明了当前的版本。
- `name` 设置了应用程序/软件包的名称。
- `description` 是应用程序/软件包的简短描述。
- `main` 设置了应用程序的入口点。
- `private` 如果设置为 `true`，则可以防止应用程序/软件包被意外地发布到 `npm`。
- `scripts` 定义了一组可以运行的 node 脚本。
- `dependencies` 设置了作为依赖安装的 `npm` 软件包的列表。
- `devDependencies` 设置了作为开发依赖安装的 `npm` 软件包的列表。
- `engines` 设置了此软件包/应用程序在哪个版本的 Node.js 上运行。
- `browserslist` 用于告知要支持哪些浏览器（及其版本）。

### 查看包版本

使用`npm list`来列出当前安装的包

或者在`package-lock.json`中查看

`npm list -g` 也一样，但适用于全局安装的软件包。

若要仅获取顶层的软件包（基本上就是告诉 npm 要安装并在 `package.json` 中列出的软件包），则运行 `npm list --depth=0`：

或者指定包的名字查看该软件包

如果要查看软件包在 npm 仓库上最新的可用版本，则运行 `npm view [package_name] version`：

### 安装包的指定版本

使用`@`来指定安装的包版本

```
npm install <package>@<version>
```

全局下安装

```
npm install -g <package>@<version>
```

可能还有需要列出软件包所有的以前的版本。 可以使用 `npm view <package> versions`：

```
npm view bootstrap versions
[
  '0.0.1',         '0.0.2',         '3.1.1',
  '3.2.0',         '3.3.0',         '3.3.1',
  '3.3.2',         '3.3.4',         '3.3.5',
  '3.3.6',         '3.3.7',         '3.4.0',
  '3.4.1',         '4.0.0-alpha.2', '4.0.0-alpha.3',
  '4.0.0-alpha.4', '4.0.0-alpha.5', '4.0.0-alpha.6',
  '4.0.0-beta',    '4.0.0-beta.2',  '4.0.0-beta.3',
  '4.0.0',         '4.1.0',         '4.1.1',
  '4.1.2',         '4.1.3',         '4.2.1',
  '4.3.0',         '4.3.1',         '4.4.0',
  '4.4.1',         '4.5.0',         '4.5.1',
  '4.5.2',         '4.5.3',         '4.6.0',
  '4.6.1',         '4.6.2',         '5.0.0-alpha1',
  '5.0.0-alpha2',  '5.0.0-alpha3',  '5.0.0-beta1',
  '5.0.0-beta2',   '5.0.0-beta3',   '5.0.0',
  '5.0.1',         '5.0.2',         '5.1.0',
  '5.1.1',         '5.1.2',         '5.1.3',
  '5.2.0-beta1',   '5.2.0'
]
```

### 将所有包更新到最新版本

当使用 `npm install <packagename>` 安装软件包时，该软件包最新的可用版本会被下载并放入 `node_modules` 文件夹中，并且还会将相应的条目添加到当前文件夹中存在的 `package.json` 和 `package-lock.json` 文件中。

如果有新的次版本或补丁版本，并且输入了 `npm update`，则已安装的版本会被更新，并且 `package-lock.json` 文件会被新版本填充。

`package.json` 则保持不变。

若要发觉软件包的新版本，则运行 `npm outdated`。

当使用`npm update`时，`npm`不会更新主版本，因为主版本一般都会有比较重大的更新，要将所有软件包更新到新的主版本，则全局地安装 `npm-check-updates` 软件包：

```
npm install -g npm-check-updates
```

之后运行

```
ncu -u
```

这会升级 `package.json` 文件的 `dependencies` 和 `devDependencies` 中的所有版本，以便 npm 可以安装新的主版本。

然后在`npm update`,这下就可以更新主版本了。

如果只是下载了项目还没有 `node_modules` 依赖包，并且想先安装新的版本，则运行：

```
npm install
```

### 语义化版本控制

语义版本控制的概念很简单：所有的版本都有 3 个数字：`x.y.z`。

- 第一个数字是主版本。
- 第二个数字是次版本。
- 第三个数字是补丁版本。

当发布新的版本时，不仅仅是随心所欲地增加数字，还要遵循以下规则：

- 当进行不兼容的 API 更改时，则升级主版本(API的更新迭代)。
- 当以向后兼容的方式添加功能时，则升级次版本(在原先的基础上增加内容)。
- 当进行向后兼容的缺陷修复时，则升级补丁版本(修复bug等)。

该约定在所有编程语言中均被采用，每个 `npm` 软件包都必须遵守该约定，这一点非常重要，因为整个系统都依赖于此。

npm更新规则:

规则使用符号(更新命令时使用)

- `^`
- `~`
- `>`
- `>=`
- `<`
- `<=`
- `=`
- `-`
- `||`

- `^`: 只会执行不更改最左边非零数字的更新。 如果写入的是 `^0.13.0`，则当运行 `npm update` 时，可以更新到 `0.13.1`、`0.13.2` 等，但不能更新到 `0.14.0` 或更高版本。 如果写入的是 `^1.13.0`，则当运行 `npm update` 时，可以更新到 `1.13.1`、`1.14.0` 等，但不能更新到 `2.0.0` 或更高版本。
- `~`: 如果写入的是 `〜0.13.0`，则当运行 `npm update` 时，会更新到补丁版本：即 `0.13.1` 可以，但 `0.14.0` 不可以。
- `>`: 接受高于指定版本的任何版本。
- `>=`: 接受等于或高于指定版本的任何版本。
- `<=`: 接受等于或低于指定版本的任何版本。
- `<`: 接受低于指定版本的任何版本。
- `=`: 接受确切的版本。
- `-`: 接受一定范围的版本。例如：`2.1.0 - 2.6.2`。
- `||`: 组合集合。例如 `< 2.1 || > 2.6`。

可以合并其中的一些符号，例如 `1.0.0 || >=1.1.0 <1.2.0`，即使用 1.0.0 或从 1.1.0 开始但低于 1.2.0 的版本。

还有其他的规则：

- 无符号: 仅接受指定的特定版本（例如 `1.2.1`）。
- `latest`: 使用可用的最新版本。

### npm卸载包

若要卸载之前在本地安装（在 `node_modules` 文件夹使用 `npm install <package-name>`）的软件包，则从项目的根文件夹（包含 `node_modules` 文件夹的文件夹）中运行：

```bash
BASH
npm uninstall <package-name>
```

如果使用 `-S` 或 `--save` 标志，则此操作还会移除 `package.json` 文件中的引用。

如果程序包是开发依赖项（列出在 `package.json` 文件的 devDependencies 中），则必须使用 `-D` 或 `--save-dev` 标志从文件中移除：

```bash
BASH
npm uninstall -S <package-name>
npm uninstall -D <package-name>
```

如果该软件包是全局安装的，则需要添加 `-g` 或 `--global` 标志：

```bash
BASH
npm uninstall -g <package-name>
```

### npm全局和本地的安装包

本地和全局的软件包之间的主要区别是：

- **本地的软件包** 安装在运行 `npm install <package-name>` 的目录中，并且放置在此目录下的 `node_modules` 文件夹中。
- **全局的软件包** 放在系统中的单独位置（确切的位置取决于设置），无论在何处运行 `npm install -g <package-name>`。

在代码中，应该只引入本地的软件包：

```js
JS
require('package-name')
```

通常，所有的软件包都应本地安装。

这样可以确保计算机中可以有数十个应用程序，并且如果需要，每个应用程序都可以运行不同的版本。

更新全局软件包会使所有的项目都使用新的版本，这可能会导致维护方面的噩梦，因为某些软件包可能会破坏与其他依赖项的兼容性等。

所有的项目都有自己的软件包本地版本，即使这看起来有点浪费资源，但与可能产生的负面影响相比也很小。

当程序包提供了可从 shell（CLI）运行的可执行命令、且可在项目间复用时，则该程序包应被全局安装。

也可以在本地安装可执行命令并使用 npx 运行，但是某些软件包最好在全局安装。

### 依赖和开发依赖

当使用 `npm install <package-name>` 安装 npm 软件包时，是将其安装为依赖项。

该软件包会被自动地列出在 package.json 文件中的 `dependencies` 列表下（在 npm 5 之前：必须手动指定 `--save`）。

当添加了 `-D` 或 `--save-dev` 标志时，则会将其安装为开发依赖项（会被添加到 `devDependencies` 列表）。

开发依赖是仅用于开发的程序包，在生产环境中并不需要。 例如测试的软件包、webpack 或 Babel。

当投入生产环境时，如果输入 `npm install` 且该文件夹包含 `package.json` 文件时，则会安装它们，因为 npm 会假定这是开发部署。

需要设置 `--production` 标志（`npm install --production`），以避免安装这些开发依赖项。